#define WIN32_LEAN_AND_MEAN							// Exclude rarely-used stuff from Windows headers 

#include <conio.h>
#include <stdio.h>
#include <windows.h>

#define STATUS_SUCCESS								((NTSTATUS)0x00000000L)

typedef LONG NTSTATUS;

typedef struct _UNICODE_STRING {
    USHORT Length;
    USHORT MaximumLength;
    PWSTR  Buffer;
} UNICODE_STRING, *PUNICODE_STRING;

typedef struct _LDR_MODULE {
	LIST_ENTRY InLoadOrderModuleList;				// Pointers to previous and next LDR_MODULE in load order
	LIST_ENTRY InMemoryOrderModuleList;				// Pointers to previous and next LDR_MODULE in memory placement order
	LIST_ENTRY InInitializationOrderModuleList;		// Pointers to previous and next LDR_MODULE in initialization order
	PVOID BaseAddress;								// Module base address known also as HMODULE
	PVOID EntryPoint;								// Module entry point (address of initialization procedure)
	ULONG SizeOfImage;								// Sum of all image's sections placed in memory. Rounded up to 4Kb (page size)
	UNICODE_STRING FullDllName;						// Path and name of module
	UNICODE_STRING BaseDllName;						// Module name only
	ULONG Flags;
	SHORT LoadCount;
	SHORT TlsIndex;
	LIST_ENTRY HashTableEntry;						// Pointer to LdrpHashTable
	ULONG TimeDateStamp;
} LDR_MODULE, *PLDR_MODULE;

typedef struct _PEB_LDR_DATA {
	ULONG Length;
	BYTE Initialized;
	PVOID SsHandle;
	LIST_ENTRY InLoadOrderModuleList;
	LIST_ENTRY InMemoryOrderModuleList;
	LIST_ENTRY InInitializationOrderModuleList;
	PVOID EntryInProgress;
} PEB_LDR_DATA, *PPEB_LDR_DATA;

typedef struct _PEB {
	BYTE InheritedAddressSpace;
	BYTE ReadImageFileExecOptions;
	BYTE BeingDebugged;
	BYTE SpareBool;
	PVOID Mutant;
	PVOID ImageBaseAddress;
	PPEB_LDR_DATA LdrData;
	// ...
} PEB, *PPEB;

typedef LONG KPRIORITY;

typedef struct _PROCESS_BASIC_INFORMATION {
	NTSTATUS ExitStatus;
	PPEB PebBaseAddress;
	ULONG_PTR AffinityMask;
	KPRIORITY BasePriority;
	ULONG_PTR UniqueProcessId;
	ULONG_PTR InheritedFromUniqueProcessId;
} PROCESS_BASIC_INFORMATION, *PPROCESS_BASIC_INFORMATION;

typedef enum _PROCESSINFOCLASS {
	ProcessBasicInformation = 0,
	ProcessWow64Information = 26
} PROCESSINFOCLASS;

typedef NTSTATUS (WINAPI *FPTR_NtQueryInformationProcess) (
	IN HANDLE ProcessHandle,
	IN PROCESSINFOCLASS ProcessInformationClass,
	OUT PVOID ProcessInformation,
	IN ULONG ProcessInformationLength,
	OUT PULONG ReturnLength OPTIONAL
	);


//
// main(int, char **)
//
int main(int argc, char* argv[])
{
	FPTR_NtQueryInformationProcess _NtQueryInformationProcess;
	PROCESS_BASIC_INFORMATION pbi;
	ULONG lRetLen;
	LDR_MODULE FirstModule, CurrentModule;

	_NtQueryInformationProcess = (FPTR_NtQueryInformationProcess) GetProcAddress(GetModuleHandle("ntdll.dll"), "NtQueryInformationProcess");

	if (STATUS_SUCCESS != _NtQueryInformationProcess(GetCurrentProcess(),
														ProcessBasicInformation,
														&pbi,
														sizeof (PROCESS_BASIC_INFORMATION),
														&lRetLen))
	{
		return 1;
	}

	printf("Press any key to hide 'ntdll.dll' from Sysinternals' ProcessExplorer...\n");
	getch();

	FirstModule = *((LDR_MODULE *) pbi.PebBaseAddress->LdrData->InLoadOrderModuleList.Flink);
	CurrentModule = FirstModule;
	do
	{
		if (_wcsicmp(CurrentModule.BaseDllName.Buffer, L"ntdll.dll") == 0)
		{
			(*((LDR_MODULE *) CurrentModule.InLoadOrderModuleList.Flink)).InLoadOrderModuleList.Blink = CurrentModule.InLoadOrderModuleList.Blink;
			(*((LDR_MODULE *) CurrentModule.InLoadOrderModuleList.Blink)).InLoadOrderModuleList.Flink = CurrentModule.InLoadOrderModuleList.Flink;
			break;
		}

		CurrentModule = *((LDR_MODULE *) CurrentModule.InLoadOrderModuleList.Flink);
	} while (CurrentModule.BaseAddress != FirstModule.BaseAddress); 

	printf("Press any key to exit...\n");
	getch();

	return 0;
}
