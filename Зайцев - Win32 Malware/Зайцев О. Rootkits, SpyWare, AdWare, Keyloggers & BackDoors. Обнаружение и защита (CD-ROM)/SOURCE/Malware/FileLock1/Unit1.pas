unit Unit1;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, Grids;

type
  TForm1 = class(TForm)
    procedure FormCreate(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  Form1: TForm1;

implementation

{$R *.dfm}

procedure LockFile(AFileName : string);
var
 hFile : THandle;
 lpOverlapped: TOverlapped;
 SizeLo, SizeHi : DWORD;
begin
 // Открытие файла
 hFile := CreateFile(PChar(AFileName),
                    GENERIC_READ,
                    FILE_SHARE_READ,
                    nil, OPEN_EXISTING,
                    FILE_ATTRIBUTE_NORMAL,0);
 if hFile = INVALID_HANDLE_VALUE then exit;
 // Определение размера файла
 SizeLo := GetFileSize(hFile, @SizeHi);
 // Блокировка файла (от начала до последнего байта)
 ZeroMemory(@lpOverlapped, sizeof(lpOverlapped));
 LockFileEx(hFile, LOCKFILE_FAIL_IMMEDIATELY or LOCKFILE_EXCLUSIVE_LOCK,
            0, SizeLo, SizeHi, lpOverlapped);
end;

procedure LockFile2(AFileName : string);
var
 hFile : THandle;
begin
 // Открытие файла
 hFile := CreateFile(PChar(AFileName),
                    GENERIC_READ,
                    0,
                    nil, OPEN_EXISTING,
                    FILE_ATTRIBUTE_NORMAL,0);
end;

procedure TForm1.FormCreate(Sender: TObject);
begin
 LockFile2(Application.ExeName);
end;

end.
 