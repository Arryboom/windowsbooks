unit Unit1;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, StdCtrls, Clipbrd;

type
  TClipbrdMon2 = class(TForm)
    Memo1: TMemo;
    procedure FormCreate(Sender: TObject);
    procedure FormDestroy(Sender: TObject);
  private
 		hNextWindow : HWND;
    procedure WMCHANGECBCHAIN(var Message: TWMCHANGECBCHAIN); message WM_CHANGECBCHAIN;
    procedure WMDRAWCLIPBOARD(var Message: TMessage); message WM_DRAWCLIPBOARD;
  public
    procedure AddToLog(S : string);
  end;

var
  ClipbrdMon2: TClipbrdMon2;

implementation

{$R *.dfm}

procedure TClipbrdMon2.AddToLog(S: string);
begin
 Memo1.Lines.Add(S);
end;

procedure TClipbrdMon2.FormCreate(Sender: TObject);
begin
 hNextWindow := SetClipboardViewer(Handle);
end;


procedure TClipbrdMon2.FormDestroy(Sender: TObject);
begin
	ChangeClipboardChain(Handle, hNextWindow);
end;

procedure TClipbrdMon2.WMCHANGECBCHAIN(var Message: TWMCHANGECBCHAIN);
begin
	if Message.Remove = hNextWindow then
    hNextWindow := Message.Next
	else
   SendMessage (hNextWindow, Message.Msg, Message.Remove, Message.Next);
end;

procedure TClipbrdMon2.WMDRAWCLIPBOARD(var Message: TMessage);
begin
 AddToLog('Изменение буфера обмена');
 AddToLog('Clipboard: "'+clipboard.AsText+'"');
 // Передаем сообщение следующему окну в цепочке
 SendMessage (hNextWindow, Message.Msg, Message.WParam, Message.LParam);
end;

end.
