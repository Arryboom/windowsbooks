library test_td;
// Демонстрационный пример внедрения троянской DLL
// Зайцев О.В, 2005. http://z-oleg.com/secur, http://z-oleg.com/delphi
uses
  WinTypes,
  WinProcs,
  Messages;

var
  HookHandle      : hHook;   // Handle, возвращаемый SetWindowsHookEx

// Функция-обработчик перехватчика
function HookProc(nCode: integer; WParam: Word; LParam: LongInt): Longint; stdcall;
var
  KeyName : string;
  Res     : integer;
begin
 if nCode = WM_NULL then
  MessageBeep(0);
 // Вызов следующего в цепочке обработчика
 Result := CallNextHookEx(HookHandle, nCode, WParam, LParam);
end;

// Установка перехватчика
procedure SetHook; stdcall;
begin
 // Устанавливаем перехватчик типа WH_GETMESSAGE - на все события
 if HookHandle = 0 then
  HookHandle      := SetWindowsHookEx(WH_GETMESSAGE, @HookProc, HInstance, 0);
end;

// Удаление перехватчика
procedure DelHook; stdcall;
begin
  if HookHandle <> 0 then begin
   UnhookWindowsHookEx(HookHandle);
   HookHandle := 0;
  end;
end;

// Экспортируемые функции:
exports
  SetHook,
  DelHook;

begin
 HookHandle := 0;
end.

